{% load static %}
<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå°Ô∏è</text></svg>" />
    <style>
        .temperature-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .temperature-card:hover {
            transform: translateY(-2px);
        }
        .temperature-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .humidity-value {
            font-size: 1.5rem;
            color: #6c757d;
        }
        .location-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
        }
        .last-updated {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .chart-container {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 15px;
        }
        .chart-canvas {
            height: 350px !important;
        }
        .stats-row {
            margin-bottom: 15px;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .error-message {
            text-align: center;
            padding: 20px;
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4" id="app">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-0"><i class="fas fa-thermometer-half me-2"></i>Temperature Dashboard</h1>
                        <p class="text-muted">Real-time monitoring of temperature and humidity</p>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        {% comment %} <!-- Device Management Link -->
                        <a href="{% url 'manage_devices' %}" class="btn btn-outline-secondary btn-sm" title="Manage Devices">
                            <i class="fas fa-cog me-1"></i>Manage Devices
                        </a> {% endcomment %}
                        <!-- Theme Switcher -->
                         <a href="#" id="theme-toggle" class="btn btn-outline-secondary btn-sm" title="Toggle Theme" @click.prevent="switchTheme">
                            <i class="fas fa-adjust"></i>
                        </a>

                        <!-- Status Indicators (Vertical Stack) -->
                        <div class="d-flex flex-column gap-2">
                            <!-- Daemon Status Indicator -->
                            <div class="d-flex align-items-center">
                                <span class="badge me-2" v-bind:class="{
                                    'bg-success': daemonStatus.status === 'active',
                                    'bg-warning': daemonStatus.status === 'stale',
                                    'bg-danger': daemonStatus.status === 'stopped' || daemonStatus.status === 'error' || daemonStatus.status === 'unknown'
                                    }">
                                    <i class="fas fa-circle me-1" style="font-size: 0.6em;"></i>
                                    <a href="/daemon/" class="text-decoration-none text-light me-3" title="View Daemon Details">
                                        Daemon
                                        [[ daemonStatus.status || 'unknown' ]]
                                    </a>
                                    </span>
                                    <small class="text-muted" v-if="daemonStatus.last_update" style="font-size: 0.75em;">
                                        Updated: [[ formatTime(daemonStatus.last_update) ]]
                                </small>
                            </div>

                            <!-- Govee Status Indicator -->
                            <div class="d-flex align-items-center">
                                <span class="badge me-2" v-bind:class="{
                                    'bg-success': goveeStatus.status === 'running',
                                    'bg-warning': goveeStatus.status === 'initialized',
                                    'bg-danger': goveeStatus.status === 'stopped' || goveeStatus.status === 'error' || goveeStatus.status === 'unknown'
                                    }">
                                    <i class="fas fa-circle me-1" style="font-size: 0.6em;"></i>
                                    <span class="text-light me-3" title="Govee Status">
                                        Govee
                                        [[ goveeStatus.status || 'unknown' ]]
                                    </span>
                                </span>
                                <small class="text-muted" v-if="goveeStatus.last_update" style="font-size: 0.75em;">
                                    Updated: [[ formatTime(goveeStatus.last_update) ]]
                                </small>
                            </div>
                        </div>

                        <button v-on:click="refreshData" v-bind:disabled="loading" class="btn btn-primary">
                            <i class="fas fa-sync-alt" v-bind:class="{'fa-spin': loading}"></i>
                            <span v-if="loading">Refreshing...</span>
                            <span v-else> Manual Refresh</span>
                            <small class="d-block" style="font-size: 0.75em; opacity: 0.8;">
                                Auto: [[ formatCounter(reload_counter) ]]
                            </small>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Temperature Cards -->
        <div class="row stats-row justify-content-center" v-if="!loading && !error">
            <div class="col mb-2" v-for="location in currentTemperatures" :key="location.pk">
                <div class="card temperature-card h-100" :class="getCardClass(location.location)">
                    <div class="card-body text-center">
                        <div class="location-name mb-2">
                            <i :class="getLocationIcon(location.location)" class="me-2"></i>
                            [[ location.location ]]
                        </div>
                        <div class="temperature-value mb-2" :class="getTemperatureColor(location.temperature)">
                            [[ location.temperature ]]¬∞C
                        </div>
                        <div class="humidity-value mb-2" v-if="location.humidity">
                            <i class="fas fa-tint me-1"></i>[[ location.humidity ]]%
                        </div>
                        <div class="last-updated mb-3">
                            <i class="fas fa-clock me-1"></i>[[ formatTimestamp(location.timestamp) ]]
                        </div>
                        <div class="mt-auto">
                            <a :href="getDeviceDetailUrl(location.location)" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-chart-line me-1"></i>View Details
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div v-if="loading" class="loading">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading temperature data...</p>
            </div>
        </div>

        <!-- Error State -->
        <div v-if="error" class="error-message">
            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
            <p>[[ error ]]</p>
            <button @click="refreshData" class="btn btn-outline-primary">Try Again</button>
        </div>

        <!-- Historical Charts -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container" v-show="!loading && !error">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3><i class="fas fa-chart-line me-2"></i>Temperature History</h3>
                        <div class="btn-group" role="group">
                            <button
                                type="button"
                                class="btn btn-outline-primary btn-sm"
                                :class="{'active': selectedTimeRange === 6}"
                                @click="changeTimeRange(6)">
                                6H
                            </button>
                            <button
                                type="button"
                                class="btn btn-outline-primary btn-sm"
                                :class="{'active': selectedTimeRange === 24}"
                                @click="changeTimeRange(24)">
                                24H
                            </button>
                            <button
                                type="button"
                                class="btn btn-outline-primary btn-sm"
                                :class="{'active': selectedTimeRange === 168}"
                                @click="changeTimeRange(168)">
                                7D
                            </button>
                        </div>
                    </div>
                    <canvas id="temperatureChart" class="chart-canvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Humidity Chart -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="chart-container" v-show="!loading && !error && hasHumidityData">
                    <h3><i class="fas fa-tint me-2"></i>Humidity History</h3>
                    <canvas id="humidityChart" class="chart-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Vue.js App -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, onMounted, computed } = Vue;

        createApp({
            delimiters: ['[[', ']]'],
            setup() {
                const currentTemperatures = ref([]);
                const historicalData = ref({});
                const loading = ref(false);
                const error = ref(null);
                const selectedTimeRange = ref(24);
                const daemonStatus = ref({status: 'unknown', running: false});
                const goveeStatus = ref({status: 'unknown', running: false});
                let temperatureChart = null;
                let humidityChart = null;
                const reload_interval = 5 * 60 * 1000; // 5 minutes
                const reload_counter = ref(reload_interval);
                let legendSelection = {};

                const hasHumidityData = computed(() => {
                    const result = Object.values(historicalData.value).some(locationData =>
                        locationData.some(entry => entry.humidity !== null && entry.humidity !== undefined)
                    );
                    console.log('hasHumidityData computed:', result, 'historicalData:', historicalData.value);
                    return result;
                });

                const getLocationIcon = (location) => {
                    const icons = {
                        'Living Room': 'fas fa-couch',
                        'Bedroom': 'fas fa-bed',
                        'Office': 'fas fa-briefcase',
                        'Outdoor': 'fas fa-tree'
                    };
                    return icons[location] || 'fas fa-map-marker-alt';
                };

                const getCardClass = (location) => {
                    const classes = {
                        'Living Room': 'border-primary',
                        'Bedroom': 'border-success',
                        'Office': 'border-warning',
                        'Outdoor': 'border-info'
                    };
                    return classes[location] || 'border-secondary';
                };

                const getDeviceDetailUrl = (location) => {
                    const deviceName = location.toLowerCase().replace(/\s+/g, '-');
                    return `/device/${deviceName}/`;
                };

                const getTemperatureColor = (temp) => {
                    if (temp < 15) return 'text-primary';
                    if (temp < 20) return 'text-info';
                    if (temp < 25) return 'text-success';
                    if (temp < 30) return 'text-warning';
                    return 'text-danger';
                };

                const formatTimestamp = (timestamp) => {
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - date) / (1000 * 60));

                    if (diffMinutes < 1) return 'Just now';
                    if (diffMinutes < 60) return `${diffMinutes}m ago`;
                    if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}h ago`;
                    return date.toLocaleDateString();
                };

                const fetchCurrentData = async (manual = false) => {
                    try {
                        const url = manual ? '/api/temperature/?manual=true' : '/api/temperature/';
                        const response = await fetch(url);
                        if (!response.ok) throw new Error('Failed to fetch current data');
                        const data = await response.json();
                        currentTemperatures.value = data;
                    } catch (err) {
                        console.error('Error fetching current data:', err);
                        throw err;
                    }
                };

                const fetchHistoricalData = async () => {
                    try {
                        const response = await fetch(`/api/historical/?hours=${selectedTimeRange.value}`);
                        if (!response.ok) throw new Error('Failed to fetch historical data');
                        const data = await response.json();
                        historicalData.value = data;
                    } catch (err) {
                        console.error('Error fetching historical data:', err);
                        throw err;
                    }
                };

                const createTemperatureChart = () => {
                    console.log('createTemperatureChart called, historicalData:', historicalData.value);

                    // Wait for DOM to be updated if needed
                    setTimeout(() => {
                        const ctx = document.getElementById('temperatureChart');
                        console.log('Creating temperature chart, ctx:', ctx);

                        if (!ctx) {
                            console.error('Temperature chart canvas element not found in DOM');
                            console.log('Available canvas elements:', document.querySelectorAll('canvas'));
                            return;
                        }

                        const datasets = Object.entries(historicalData.value).map(([location, data], index) => {
                            const colors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'];
                            return {
                                label: location,
                                data: data.map(entry => ({
                                    x: new Date(entry.timestamp),
                                    y: entry.temperature
                                })),
                                borderColor: colors[index % colors.length],
                                backgroundColor: colors[index % colors.length] + '20',
                                tension: 0.1,
                                fill: false
                            };
                        });

                        const config = {
                            type: 'line',
                            data: { datasets },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'index',
                                    intersect: false,
                                },
                                scales: {
                                    x: {
                                        type: 'time',
                                        time: {
                                            displayFormats: {
                                                hour: 'HH:mm',
                                                day: 'MMM DD'
                                            }
                                        },
                                        title: {
                                            display: true,
                                            text: 'Time'
                                        }
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: 'Temperature (¬∞C)'
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        position: 'top',
                                        onClick: (e, legendItem, legend) => {
                                            // default behavior
                                            Chart.defaults.plugins.legend.onClick.call(this, e, legendItem, legend);
                                            // Toggle visibility of corresponding humidity dataset
                                            // when clicking on temperature legend item
                                            const index = legendItem.datasetIndex;
                                            if (humidityChart && humidityChart.data.datasets[index]) {
                                                const humidityMeta = humidityChart.getDatasetMeta(index);
                                                humidityMeta.hidden = !humidityMeta.hidden;
                                                humidityChart.update();
                                            }
                                        }
                                    },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false,
                                    }
                                }
                            }
                        };

                        if (temperatureChart) {
                            console.log('Destroying existing temperature chart');
                            temperatureChart.destroy();
                        }

                        console.log('Creating temperature chart with config:', config);
                        temperatureChart = new Chart(ctx, config);
                        console.log('Temperature chart created successfully');
                    }, 50); // Small delay to ensure DOM is ready
                };

                const createHumidityChart = () => {
                    console.log('createHumidityChart called, hasHumidityData:', hasHumidityData.value);

                    if (!hasHumidityData.value) {
                        console.log('No humidity data available, skipping chart creation');
                        return;
                    }

                    // Wait for DOM to be updated if the humidity section was just shown
                    setTimeout(() => {
                        const ctx = document.getElementById('humidityChart');
                        console.log('Creating humidity chart, ctx:', ctx);

                        if (!ctx) {
                            console.error('Humidity chart canvas element not found in DOM');
                            console.log('Available canvas elements:', document.querySelectorAll('canvas'));
                            return;
                        }

                    const datasets = Object.entries(historicalData.value)
                        .filter(([, data]) => data.some(entry => entry.humidity !== null))
                        .map(([location, data], index) => {
                            const colors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'];
                            return {
                                label: location,
                                data: data
                                    .filter(entry => entry.humidity !== null)
                                    .map(entry => ({
                                        x: new Date(entry.timestamp),
                                        y: entry.humidity
                                    })),
                                borderColor: colors[index % colors.length],
                                backgroundColor: colors[index % colors.length] + '20',
                                tension: 0.1,
                                fill: false
                            };
                        });

                    const config = {
                        type: 'line',
                        data: { datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        displayFormats: {
                                            hour: 'HH:mm',
                                            day: 'MMM DD'
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Time'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Humidity (%)'
                                    },
                                    min: 0,
                                    max: 100
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                }
                            }
                        }
                    };

                        if (humidityChart) {
                            humidityChart.destroy();
                        }
                        console.log('Creating humidity chart with config:', config);
                        humidityChart = new Chart(ctx, config);
                        console.log('Humidity chart created successfully');
                    }, 50); // Small delay to ensure DOM is ready
                };

                const fetchDaemonStatus = async () => {
                    try {
                        const response = await fetch('/api/daemon/status/');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        daemonStatus.value = data;
                    } catch (err) {
                        console.error('Error fetching daemon status:', err);
                        daemonStatus.value = {
                            status: 'error',
                            running: false,
                            error: 'Failed to fetch daemon status'
                        };
                    }
                };

                const fetchGoveeStatus = async () => {
                    try {
                        const response = await fetch('/api/govee/status/');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        goveeStatus.value = data;
                    } catch (err) {
                        console.error('Error fetching Govee status:', err);
                        goveeStatus.value = {
                            status: 'error',
                            last_update: null,
                            error: 'Failed to fetch Govee status'
                        };
                    }
                };

                const refreshData = async () => {
                    loading.value = true;
                    error.value = null;

                    try {
                        await Promise.all([
                            fetchCurrentData(true), // Manual refresh - fetch from devices
                            fetchHistoricalData(),
                            fetchDaemonStatus(),
                            fetchGoveeStatus()
                        ]);

                        // Wait for DOM update before creating charts
                        await new Promise(resolve => setTimeout(resolve, 200));
                        createHumidityChart();
                        createTemperatureChart();

                        // Reset the auto-refresh counter
                        reload_counter.value = reload_interval;
                    } catch (err) {
                        error.value = err.message || 'Failed to load data';
                    } finally {
                        loading.value = false;
                    }
                };

                const autoRefreshData = async () => {
                    // Auto-refresh only fetches from database (updated by daemon)
                    // No loading spinner for this background refresh
                    try {
                        await Promise.all([
                            fetchCurrentData(),
                            fetchHistoricalData(),
                            fetchDaemonStatus(),
                            fetchGoveeStatus()
                        ]);

                        // Update charts with new data
                        createOrUpdateHumidityChart();
                        createOrUpdateTemperatureChart();

                        console.log('Auto-refresh completed at', new Date().toLocaleTimeString());
                    } catch (err) {
                        console.error('Auto-refresh failed:', err);
                        // Don't show error to user for background refresh
                    }
                };

                const changeTimeRange = async (hours) => {
                    selectedTimeRange.value = hours;
                    await fetchHistoricalData();
                    createHumidityChart();
                    createTemperatureChart();
                };

                const updateRefreshCounter = () => {
                    reload_counter.value -= 1000;
                    if (reload_counter.value <= 0) {
                        reload_counter.value = reload_interval;
                        // Trigger auto-refresh from database when counter reaches zero
                        autoRefreshData();
                    }
                };

                const formatCounter = (milliseconds) => {
                    const mins = Math.floor(milliseconds / 60000);
                    const secs = Math.floor((milliseconds % 60000) / 1000);
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                };

                const switchTheme = () => {
                    const htmlElement = document.documentElement;
                    const currentTheme = htmlElement.getAttribute('data-bs-theme');
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    htmlElement.setAttribute('data-bs-theme', newTheme);
                    localStorage.setItem('theme', newTheme);
                };

                onMounted(() => {
                    autoRefreshData();
                    // Only run the counter timer - auto-refresh is handled by updateRefreshCounter
                    setInterval(updateRefreshCounter, 1000);
                    // set theme based on saved preference
                    const savedTheme = localStorage.getItem('theme');
                    if (savedTheme) {
                        document.documentElement.setAttribute('data-bs-theme', savedTheme);
                    }
                });

                const formatTime = (isoString) => {
                    if (!isoString) return 'Never';
                    const date = new Date(isoString);
                    return date.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                };

                const createOrUpdateTemperatureChart = () => {
                    if (!temperatureChart) {
                        createTemperatureChart();
                        return;
                    }

                    // Check if we need to recreate due to location changes
                    const currentLocations = Object.keys(historicalData.value);
                    const chartLocations = temperatureChart.data.datasets.map(ds => ds.label);

                    if (currentLocations.length !== chartLocations.length ||
                        !currentLocations.every(loc => chartLocations.includes(loc))) {
                        console.log('Location count or names changed, recreating temperature chart');
                        createTemperatureChart();
                        return;
                    }

                    // Update existing datasets
                    Object.entries(historicalData.value).forEach(([location, locationData], index) => {
                        const dataset = temperatureChart.data.datasets[index];
                        if (dataset && dataset.label === location) {
                            dataset.data = locationData.map(entry => ({
                                x: new Date(entry.timestamp),
                                y: entry.temperature
                            }));
                        }
                    });

                    temperatureChart.update();
                };

                const createOrUpdateHumidityChart = () => {
                    if (!hasHumidityData.value) {
                        if (humidityChart) {
                            humidityChart.destroy();
                            humidityChart = null;
                        }
                        return;
                    }

                    if (!humidityChart) {
                        createHumidityChart();
                        return;
                    }

                    // Check if we need to recreate due to location changes
                    const currentHumidityLocations = Object.entries(historicalData.value)
                        .filter(([, data]) => data.some(entry => entry.humidity !== null))
                        .map(([location]) => location);
                    const chartLocations = humidityChart.data.datasets.map(ds => ds.label);

                    if (currentHumidityLocations.length !== chartLocations.length ||
                        !currentHumidityLocations.every(loc => chartLocations.includes(loc))) {
                        console.log('Humidity location count or names changed, recreating humidity chart');
                        createHumidityChart();
                        return;
                    }

                    // Update existing datasets
                    Object.entries(historicalData.value)
                        .filter(([, data]) => data.some(entry => entry.humidity !== null))
                        .forEach(([location, locationData], index) => {
                            const dataset = humidityChart.data.datasets[index];
                            if (dataset && dataset.label === location) {
                                dataset.data = locationData
                                    .filter(entry => entry.humidity !== null)
                                    .map(entry => ({
                                        x: new Date(entry.timestamp),
                                        y: entry.humidity
                                    }));
                            }
                        });

                    humidityChart.update();
                };

                return {
                    currentTemperatures,
                    historicalData,
                    loading,
                    error,
                    selectedTimeRange,
                    hasHumidityData,
                    daemonStatus,
                    goveeStatus,
                    refreshData,
                    changeTimeRange,
                    getLocationIcon,
                    getCardClass,
                    getDeviceDetailUrl,
                    getTemperatureColor,
                    formatTimestamp,
                    formatTime,
                    reload_counter,
                    formatCounter,
                    switchTheme
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
